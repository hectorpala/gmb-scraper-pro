/**
 * GMB Scraper - Frontend Application
 */

const state = {
  isLoading: false,
  results: [],
  exports: { json: null, csv: null },
  googleSheets: { configured: false, authenticated: false, url: null }
};

const elements = {};

async function init() {
  elements.form = document.getElementById('searchForm');
  elements.searchBtn = document.getElementById('searchBtn');
  elements.btnText = document.querySelector('.btn-text');
  elements.btnLoading = document.querySelector('.btn-loading');
  elements.progressSection = document.getElementById('progressSection');
  elements.progressText = document.getElementById('progressText');
  elements.progressPercent = document.getElementById('progressPercent');
  elements.progressFill = document.getElementById('progressFill');
  elements.messageSection = document.getElementById('messageSection');
  elements.messageBox = document.getElementById('messageBox');
  elements.resultsSection = document.getElementById('resultsSection');
  elements.resultsCount = document.getElementById('resultsCount');
  elements.resultsBody = document.getElementById('resultsBody');
  elements.exportCsv = document.getElementById('exportCsv');
  elements.exportJson = document.getElementById('exportJson');
  elements.exportSheets = document.getElementById('exportSheets');
  elements.googleIcon = document.getElementById('googleIcon');
  elements.googleStatusText = document.getElementById('googleStatusText');
  elements.googleConnectBtn = document.getElementById('googleConnectBtn');
  elements.sheetsOptionGroup = document.getElementById('sheetsOptionGroup');
  elements.exportToSheets = document.getElementById('exportToSheets');

  elements.form.addEventListener('submit', handleSubmit);
  elements.exportCsv.addEventListener('click', function() { downloadExport('csv'); });
  elements.exportJson.addEventListener('click', function() { downloadExport('json'); });
  elements.exportSheets.addEventListener('click', openGoogleSheets);
  elements.googleConnectBtn.addEventListener('click', connectGoogleSheets);

  await checkGoogleStatus();
  
  // Verificar estado cada 3 segundos mientras no este autenticado
  setInterval(async function() {
    if (!state.googleSheets.authenticated) {
      await checkGoogleStatus();
    }
  }, 3000);
}

async function checkGoogleStatus() {
  try {
    const response = await fetch('/api/google/status');
    const result = await response.json();

    if (result.success) {
      const wasNotAuth = !state.googleSheets.authenticated;
      state.googleSheets.configured = result.data.configured;
      state.googleSheets.authenticated = result.data.authenticated;
      updateGoogleUI();
      
      // Mostrar mensaje si acaba de autenticarse
      if (wasNotAuth && result.data.authenticated) {
        showMessage('Google Sheets conectado exitosamente!', 'success');
      }
    }
  } catch (error) {
    console.error('Error verificando Google:', error);
  }
}

function updateGoogleUI() {
  const { configured, authenticated } = state.googleSheets;

  if (!configured) {
    elements.googleIcon.className = 'google-icon not-configured';
    elements.googleStatusText.textContent = 'Google Sheets no configurado';
    elements.googleConnectBtn.style.display = 'none';
    elements.sheetsOptionGroup.style.display = 'none';
  } else if (!authenticated) {
    elements.googleIcon.className = 'google-icon disconnected';
    elements.googleStatusText.textContent = 'Google Sheets: No conectado';
    elements.googleConnectBtn.style.display = 'inline-flex';
    elements.sheetsOptionGroup.style.display = 'none';
  } else {
    elements.googleIcon.className = 'google-icon connected';
    elements.googleStatusText.textContent = 'Google Sheets: Conectado';
    elements.googleConnectBtn.style.display = 'none';
    elements.sheetsOptionGroup.style.display = 'block';
  }
}

async function connectGoogleSheets() {
  try {
    elements.googleConnectBtn.disabled = true;
    elements.googleConnectBtn.textContent = 'Conectando...';
    
    const response = await fetch('/api/google/connect');
    const result = await response.json();

    if (result.success && result.data.authUrl) {
      // Abrir ventana de autorizacion de Google
      window.open(result.data.authUrl, '_blank', 'width=500,height=600');
      showMessage('Completa la autorizacion en la ventana que se abrio', 'info');
    } else {
      showMessage(result.error || 'Error conectando', 'error');
    }
  } catch (error) {
    showMessage('Error: ' + error.message, 'error');
  } finally {
    elements.googleConnectBtn.disabled = false;
    elements.googleConnectBtn.textContent = 'Conectar Google Sheets';
  }
}

async function handleSubmit(event) {
  event.preventDefault();
  if (state.isLoading) return;

  const formData = new FormData(elements.form);
  const data = {
    businessType: formData.get('businessType').trim(),
    city: formData.get('city').trim(),
    country: formData.get('country').trim(),
    maxResults: parseInt(formData.get('maxResults')) || 50,
    exportToGoogleSheets: state.googleSheets.authenticated && elements.exportToSheets && elements.exportToSheets.checked
  };

  if (!data.businessType || !data.city || !data.country) {
    showMessage('Por favor complete todos los campos', 'error');
    return;
  }

  await performSearch(data);
}

async function performSearch(data) {
  setLoading(true);
  hideMessage();
  hideResults();
  showProgress();

  try {
    updateProgress('Conectando con el servidor...', 5);

    const response = await fetch('/api/scrape', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    updateProgress('Procesando resultados...', 90);
    const result = await response.json();

    if (!result.success) {
      throw new Error(result.error || 'Error desconocido');
    }

    updateProgress('Completado!', 100);
    
    state.results = result.data.businesses;
    state.exports = {
      json: result.data.exports.json,
      csv: result.data.exports.csv
    };

    if (result.data.googleSheets) {
      state.googleSheets.url = result.data.googleSheets.url;
      elements.exportSheets.style.display = 'inline-flex';
    }

    setTimeout(function() {
      hideProgress();
      showResults(result.data);
      
      if (result.data.googleSheets) {
        showMessage('Guardado en Google Sheets: ' + result.data.googleSheets.title, 'success');
      }
    }, 500);

  } catch (error) {
    hideProgress();
    showMessage(error.message || 'Error al realizar la busqueda', 'error');
  } finally {
    setLoading(false);
  }
}

function setLoading(loading) {
  state.isLoading = loading;
  elements.searchBtn.disabled = loading;
  elements.btnText.style.display = loading ? 'none' : 'inline';
  elements.btnLoading.style.display = loading ? 'inline-flex' : 'none';
}

function showProgress() {
  elements.progressSection.style.display = 'block';
  updateProgress('Iniciando...', 0);
}

function hideProgress() {
  elements.progressSection.style.display = 'none';
}

function updateProgress(text, percent) {
  elements.progressText.textContent = text;
  elements.progressPercent.textContent = percent + '%';
  elements.progressFill.style.width = percent + '%';
}

function showMessage(message, type) {
  elements.messageBox.textContent = message;
  elements.messageBox.className = 'message-box ' + type;
  elements.messageSection.style.display = 'block';
}

function hideMessage() {
  elements.messageSection.style.display = 'none';
}

function showResults(data) {
  const { businesses, duration } = data;
  elements.resultsCount.textContent = businesses.length + ' negocios encontrados en ' + duration;
  elements.resultsBody.innerHTML = '';

  businesses.forEach(function(business, index) {
    const row = createResultRow(business, index + 1);
    elements.resultsBody.appendChild(row);
  });

  elements.resultsSection.style.display = 'block';
}

function hideResults() {
  elements.resultsSection.style.display = 'none';
  elements.exportSheets.style.display = 'none';
}

function createResultRow(business, position) {
  const tr = document.createElement('tr');
  
  const ratingHtml = business.rating 
    ? '<span class="rating-star">&#9733;</span> ' + business.rating.toFixed(1)
    : '-';

  const reviewsText = business.reviewCount 
    ? business.reviewCount.toLocaleString()
    : '-';

  const websiteHtml = business.website 
    ? '<a href="' + escapeHtml(business.website) + '" target="_blank">Ver</a>'
    : '-';

  const profileHtml = business.profileUrl 
    ? '<a href="' + escapeHtml(business.profileUrl) + '" target="_blank">Ver</a>'
    : '-';

  tr.innerHTML = 
    '<td>' + position + '</td>' +
    '<td><strong>' + escapeHtml(business.name || '-') + '</strong></td>' +
    '<td>' + ratingHtml + '</td>' +
    '<td>' + reviewsText + '</td>' +
    '<td>' + escapeHtml(business.category || '-') + '</td>' +
    '<td class="truncate" title="' + escapeHtml(business.address || '') + '">' + escapeHtml(business.address || '-') + '</td>' +
    '<td>' + escapeHtml(business.phone || '-') + '</td>' +
    '<td>' + websiteHtml + '</td>' +
    '<td>' + profileHtml + '</td>';

  return tr;
}

function downloadExport(format) {
  const url = state.exports[format];
  if (url) window.open(url, '_blank');
}

function openGoogleSheets() {
  if (state.googleSheets.url) window.open(state.googleSheets.url, '_blank');
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

document.addEventListener('DOMContentLoaded', init);
