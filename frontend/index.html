<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GMB Scraper Pro v2.0</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Ocultar autocompletado de Chrome */
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus,
    input:-webkit-autofill:active {
      -webkit-box-shadow: 0 0 0 30px white inset !important;
      -webkit-text-fill-color: #333 !important;
      transition: background-color 5000s ease-in-out 0s;
    }
    
    input::-webkit-contacts-auto-fill-button,
    input::-webkit-credentials-auto-fill-button {
      visibility: hidden;
      display: none !important;
      pointer-events: none;
      height: 0;
      width: 0;
      margin: 0;
    }


    /* Estilos adicionales para v2 */
    .tabs { display: flex; gap: 0; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; }
    .tab { padding: 12px 24px; cursor: pointer; border: none; background: none; color: #666; font-size: 14px; font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
    .tab:hover { color: #4285F4; }
    .tab.active { color: #4285F4; border-bottom-color: #4285F4; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .filters-section { background: #f8f9fa; border-radius: 8px; padding: 16px; margin-top: 16px; }
    .filters-title { font-size: 14px; font-weight: 600; color: #333; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .filters-title::before { content: ''; width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 6px solid #666; transition: transform 0.2s; }
    .filters-title.collapsed::before { transform: rotate(-90deg); }
    .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
    .filters-content { display: block; }
    .filters-content.collapsed { display: none; }
    
    .filter-group { display: flex; flex-direction: column; gap: 4px; }
    .filter-group label { font-size: 12px; color: #666; }
    .filter-group input, .filter-group select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
    .filter-group input[type="checkbox"] { width: auto; }
    
    .checkbox-row { display: flex; align-items: center; gap: 8px; }
    .checkbox-row label { font-size: 13px; color: #333; cursor: pointer; }
    
    .geo-inputs { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .geo-inputs .form-group { margin-bottom: 0; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .stat-card { background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; text-align: center; }
    .stat-value { font-size: 24px; font-weight: 700; color: #4285F4; }
    .stat-label { font-size: 12px; color: #666; margin-top: 4px; }
    
    .results-table th, .results-table td { font-size: 12px; padding: 8px 6px; }
    .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; }
    .badge-email { background: #e3f2fd; color: #1976d2; }
    .badge-phone { background: #e8f5e9; color: #388e3c; }
    .badge-social { background: #fce4ec; color: #c2185b; }
    
    .social-icons { display: flex; gap: 4px; }
    .social-icon { width: 20px; height: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; text-decoration: none; color: white; }
    .social-icon.ig { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); }
    .social-icon.fb { background: #1877f2; }
    .social-icon.wa { background: #25d366; }
    .social-icon.tw { background: #1da1f2; }
    
    .version-badge { background: #4285F4; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px; }
    
    .preview-section { margin: 20px 0; }
    .preview-card { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #4285F4; border-radius: 16px; padding: 32px; text-align: center; animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .preview-icon { font-size: 48px; margin-bottom: 12px; }
    .preview-card h3 { color: #1e40af; margin: 0 0 16px; font-size: 18px; }
    .preview-count { margin: 20px 0; }
    .preview-count span:first-child { font-size: 56px; font-weight: 800; color: #4285F4; display: block; line-height: 1; }
    .preview-label { font-size: 16px; color: #666; }
    .preview-samples { margin: 20px 0; padding: 16px; background: white; border-radius: 8px; text-align: left; }
    .preview-samples p { margin: 0 0 8px; font-size: 12px; color: #666; font-weight: 600; }
    .preview-samples ul { margin: 0; padding-left: 20px; }
    .preview-samples li { font-size: 13px; color: #333; margin: 4px 0; }
    .preview-actions { display: flex; justify-content: center; gap: 12px; margin-top: 20px; }
    .button-group { display: flex; gap: 12px; }
    
    /* ========== NUEVO DISE칌O DE DROPDOWNS ========== */
    
    /* Contenedor de negocio/profesion */
    .business-section {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 1px solid #f59e0b;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .business-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      color: #92400e;
      font-weight: 600;
      font-size: 14px;
    }
    
    .business-header svg {
      width: 20px;
      height: 20px;
      color: #f59e0b;
    }
    
    .business-section .custom-select {
      margin: 0;
    }
    
    .business-section .dropdown-menu {
      max-height: 350px;
    }
    
    .category-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #fef3c7;
      color: #92400e;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    /* Contenedor de ubicacion con mejor estructura */
    .location-section {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .geo-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      font-size: 12px;
      background: #4285F4;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-left: auto;
      transition: all 0.2s;
    }
    
    .geo-btn:hover {
      background: #3367d6;
      transform: scale(1.02);
    }
    
    .geo-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .geo-btn.loading {
      opacity: 0.7;
    }
    
    .geo-btn svg {
      width: 14px;
      height: 14px;
    }
    
    
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      color: #1e40af;
      font-weight: 600;
      font-size: 14px;
    }

    .location-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .location-header svg {
      width: 20px;
      height: 20px;
      color: #4285F4;
    }
    
    .location-header span {
      font-size: 14px;
      font-weight: 600;
      color: #334155;
    }
    
    .location-fields {
      display: grid;
      grid-template-columns: 1fr 1.5fr;
      gap: 16px;
    }
    
    /* Custom Select/Dropdown */
    .custom-select {
      position: relative;
    }
    
    .custom-select label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .custom-select label .optional {
      font-size: 10px;
      font-weight: 400;
      color: #94a3b8;
      text-transform: none;
    }
    
    .custom-select label .required {
      color: #ef4444;
      font-size: 10px;
    }
    
    .select-wrapper {
      position: relative;
    }
    
    .select-wrapper input {
      width: 100%;
      padding: 12px 40px 12px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      color: #1e293b;
      background: white;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .select-wrapper input:hover {
      border-color: #cbd5e1;
    }
    
    .select-wrapper input:focus {
      outline: none;
      border-color: #4285F4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }
    
    .select-wrapper input::placeholder {
      color: #94a3b8;
    }
    
    /* Icono de flecha */
    .select-arrow {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: #64748b;
      transition: transform 0.2s ease;
    }
    
    .select-wrapper input:focus + .select-arrow {
      transform: translateY(-50%) rotate(180deg);
      color: #4285F4;
    }
    
    /* Boton de limpiar */
    .select-clear {
      position: absolute;
      right: 36px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      border: none;
      background: #e2e8f0;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #64748b;
      transition: all 0.2s;
    }
    
    .select-clear:hover {
      background: #cbd5e1;
      color: #475569;
    }
    
    .select-wrapper input:not(:placeholder-shown) ~ .select-clear {
      display: flex;
    }
    
    /* Dropdown personalizado */
    .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      max-height: 280px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      margin-top: 4px;
    }
    
    .dropdown-menu.show {
      display: block;
      animation: dropdownFade 0.15s ease-out;
    }
    
    @keyframes dropdownFade {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .dropdown-header {
      padding: 10px 14px;
      font-size: 11px;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
      position: sticky;
      top: 0;
    }
    
    .dropdown-item {
      padding: 10px 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.15s;
      border-bottom: 1px solid #f1f5f9;
    }
    
    .dropdown-item:last-child {
      border-bottom: none;
    }
    
    .dropdown-item:hover {
      background: #f1f5f9;
    }
    
    .dropdown-item.selected {
      background: #eff6ff;
      color: #4285F4;
    }
    
    .dropdown-item .item-icon {
      width: 24px;
      height: 24px;
      background: #f1f5f9;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    .dropdown-item .item-text {
      flex: 1;
    }
    
    .dropdown-item .item-text .main {
      font-size: 14px;
      color: #1e293b;
    }
    
    .dropdown-item .item-text .sub {
      font-size: 11px;
      color: #94a3b8;
    }
    
    .dropdown-item .item-count {
      font-size: 11px;
      color: #94a3b8;
      background: #f1f5f9;
      padding: 2px 8px;
      border-radius: 10px;
    }
    
    
    
    .dropdown-separator {
      padding: 8px 12px;
      font-size: 11px;
      color: #666;
      background: #f8fafc;
      border-top: 1px solid #e2e8f0;
      border-bottom: 1px solid #e2e8f0;
      margin: 8px 0;
    }
    
    
    .cp-toggle-btn {
      display: block;
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 1px dashed #f59e0b;
      border-radius: 8px;
      color: #92400e;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .cp-toggle-btn:hover {
      background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
      transform: scale(1.01);
    }
    
    .cp-item {
      background: linear-gradient(90deg, #fef9c3 0%, transparent 100%);
    }
    
    .cp-item:hover {
      background: linear-gradient(90deg, #fef08a 0%, #fef9c3 100%);
    }

    .recent-item {
      background: linear-gradient(90deg, #fef3c7 0%, transparent 100%);
    }

    .dropdown-item.keyboard-active {
      background: #e0f2fe !important;
      border-left: 3px solid #4285F4;
    }

    .dropdown-empty {
      padding: 20px;
      text-align: center;
      color: #94a3b8;
      font-size: 13px;
    }
    
    /* Estado seleccionado visual */
    .has-value input {
      font-weight: 500;
      color: #1e293b;
    }
    
    /* Pais field simplificado */
    .country-field {
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #f1f5f9;
      border-radius: 8px;
      font-size: 13px;
      color: #64748b;
    }
    
    .country-field .flag {
      font-size: 16px;
    }
    
    .country-field input {
      border: none;
      background: transparent;
      font-size: 13px;
      color: #334155;
      font-weight: 500;
      width: 100px;
    }
    
    .country-field input:focus {
      outline: none;
    }
    
  
    /* Modal de duplicados */
    .duplicate-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.2s ease-out;
    }
    
    .duplicate-modal-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .duplicate-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .duplicate-modal-content h3 {
      margin: 0 0 12px;
      color: #b45309;
      font-size: 20px;
    }
    
    .duplicate-count {
      background: #fef3c7;
      color: #92400e;
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
      margin: 16px 0;
    }
    
    .duplicate-list {
      text-align: left;
      background: #f8fafc;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .duplicate-list ul {
      margin: 8px 0 0 0;
      padding-left: 20px;
    }
    
    .duplicate-list li {
      font-size: 13px;
      color: #666;
      margin: 4px 0;
    }
    
    .duplicate-list .more {
      font-size: 12px;
      color: #999;
      font-style: italic;
      margin-top: 8px;
    }
    
    .duplicate-question {
      font-weight: 600;
      margin: 16px 0 8px;
    }
    
    .duplicate-note {
      font-size: 12px;
      color: #666;
      margin-bottom: 20px;
    }
    
    .duplicate-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <span style="color:#4285F4">G</span><span style="color:#EA4335">M</span><span style="color:#FBBC04">B</span>
      </div>
      <h1>Google My Business Scraper <span class="version-badge">PRO v2.0</span></h1>
      <p class="subtitle">Extrae 40+ campos de negocios incluyendo emails y redes sociales</p>
    </header>

    <main>
      <!-- Google Sheets Status -->
      <section id="googleSection" class="google-section">
        <div class="google-status">
          <span id="googleIcon" class="google-icon"></span>
          <span id="googleStatusText">Verificando Google Sheets...</span>
          <button id="googleConnectBtn" class="btn btn-google" style="display: none;">Conectar Google Sheets</button>
        </div>
      </section>

      <!-- Tabs de busqueda -->
      <section class="search-section">
        <div class="tabs">
          <button class="tab active" data-tab="ciudad">Buscar por Ciudad</button>
          <button class="tab" data-tab="geo">Buscar por Coordenadas</button>
        </div>

        <form id="searchForm" autocomplete="off">
          <!-- Tab Ciudad -->
          <div class="tab-content active" id="tab-ciudad">
            <!-- Dropdown de Profesiones -->
            <div class="business-section">
              <div class="business-header">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                <span>Tipo de Negocio</span>
              </div>
              
              <div class="custom-select" id="businessSelect">
                <label>
                  Profesion o Negocio <span class="required">*</span>
                </label>
                <div class="select-wrapper">
                  <input type="text" id="businessType" name="btype_x7k9" placeholder="Escribe o selecciona..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-lpignore="true" data-form-type="other" data-1p-ignore="true" aria-autocomplete="none" required>
                  <button type="button" class="select-clear" id="businessClear">&times;</button>
                  <svg class="select-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                  </svg>
                </div>
                <div class="dropdown-menu" id="businessDropdown">
                  <div class="dropdown-header" id="businessDropdownHeader">Profesiones populares</div>
                  <div id="businessOptions"></div>
                </div>
              </div>
            </div>
            
            <!-- Nueva seccion de ubicacion mejorada -->
            <div class="location-section">
              <div class="location-header">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span>Ubicacion</span>
                <button type="button" id="geolocateBtn" class="geo-btn" title="Usar mi ubicacion">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <circle cx="12" cy="12" r="3"/>
                    <line x1="12" y1="2" x2="12" y2="6"/>
                    <line x1="12" y1="18" x2="12" y2="22"/>
                    <line x1="2" y1="12" x2="6" y2="12"/>
                    <line x1="18" y1="12" x2="22" y2="12"/>
                  </svg>
                  Mi ubicacion
                </button>
              </div>
              
              <div class="location-fields">
                <!-- Estado Dropdown -->
                <div class="custom-select" id="stateSelect">
                  <label>
                    Estado <span class="optional">(opcional)</span>
                  </label>
                  <div class="select-wrapper">
                    <input type="text" id="state" name="st_x7k9" placeholder="Escribe o selecciona..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-lpignore="true" data-form-type="other" data-1p-ignore="true">
                    <button type="button" class="select-clear" id="stateClear">&times;</button>
                    <svg class="select-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M6 9l6 6 6-6"/>
                    </svg>
                  </div>
                  <div class="dropdown-menu" id="stateDropdown">
                    <div class="dropdown-header">32 Estados de Mexico</div>
                    <div id="stateOptions"></div>
                  </div>
                </div>
                
                <!-- Ciudad Dropdown -->
                <div class="custom-select" id="citySelect">
                  <label>
                    Ciudad <span class="required">*</span>
                  </label>
                  <div class="select-wrapper">
                    <input type="text" id="city" name="ct_x7k9" placeholder="Escribe o selecciona..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-lpignore="true" data-form-type="other" data-1p-ignore="true" required>
                    <button type="button" class="select-clear" id="cityClear">&times;</button>
                    <svg class="select-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M6 9l6 6 6-6"/>
                    </svg>
                  </div>
                  <div class="dropdown-menu" id="cityDropdown">
                    <div class="dropdown-header" id="cityDropdownHeader">Ciudades populares</div>
                    <div id="cityOptions"></div>
                  </div>
                </div>
              </div>
              
              <div class="country-field">
                <span class="flag">游쓇릖</span>
                <span>Pais:</span>
                <input type="text" id="country" name="co_x7k9" value="Mexico" required autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-lpignore="true" data-form-type="other" data-1p-ignore="true">
              </div>
            </div>
          </div>

          <!-- Tab Geolocalizacion -->
          <div class="tab-content" id="tab-geo">
            <div class="form-group">
              <label for="businessTypeGeo">Tipo de Negocio</label>
              <input type="text" id="businessTypeGeo" name="btypegeo_x7k9" placeholder="ej: plomeria, electricistas..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-lpignore="true" data-form-type="other" data-1p-ignore="true">
            </div>
            <div class="geo-inputs">
              <div class="form-group">
                <label for="latitude">Latitud</label>
                <input type="text" id="latitude" name="lat_x7k9" placeholder="ej: 25.6866" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-lpignore="true" data-form-type="other" data-1p-ignore="true">
              </div>
              <div class="form-group">
                <label for="longitude">Longitud</label>
                <input type="text" id="longitude" name="lng_x7k9" placeholder="ej: -100.3161" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-lpignore="true" data-form-type="other" data-1p-ignore="true">
              </div>
              <div class="form-group">
                <label for="radius">Radio (km)</label>
                <input type="number" id="radius" name="rad_x7k9" placeholder="5" min="0.5" max="50" step="0.5" value="5">
              </div>
            </div>
            <p style="font-size: 12px; color: #666; margin-top: 8px;">Tip: Busca las coordenadas en Google Maps y copialas aqui</p>
          </div>

          <!-- Cantidad de resultados -->
          <div class="form-group">
            <label for="maxResults">Cantidad de resultados</label>
            <select id="maxResults" name="max_x7k9">
              <option value="10">10 negocios</option>
              <option value="25">25 negocios</option>
              <option value="50" selected>50 negocios</option>
              <option value="100">100 negocios</option>
              <option value="150">150 negocios</option>
              <option value="200">200 negocios</option>
            </select>
          </div>

          <!-- Opciones avanzadas -->
          <div class="filters-section">
            <div class="filters-title" id="filtersToggle">Opciones avanzadas</div>
            <div class="filters-content" id="filtersContent">
              <div class="filters-grid">
                <div class="checkbox-row">
                  <input type="checkbox" id="extractEmails" name="extractEmails" checked>
                  <label for="extractEmails">Extraer emails</label>
                </div>
                <div class="checkbox-row">
                  <input type="checkbox" id="extractSocial" name="extractSocial" checked>
                  <label for="extractSocial">Extraer redes sociales</label>
                </div>
              </div>
              
              <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                <p style="font-size: 12px; font-weight: 600; color: #333; margin-bottom: 8px;">Filtros de resultados</p>
                <div class="filters-grid">
                  <div class="filter-group">
                    <label for="minRating">Rating minimo</label>
                    <select id="minRating" name="minRating">
                      <option value="">Sin filtro</option>
                      <option value="3">3+ estrellas</option>
                      <option value="3.5">3.5+ estrellas</option>
                      <option value="4">4+ estrellas</option>
                      <option value="4.5">4.5+ estrellas</option>
                    </select>
                  </div>
                  <div class="filter-group">
                    <label for="minReviews">Resenas minimas</label>
                    <select id="minReviews" name="minReviews">
                      <option value="">Sin filtro</option>
                      <option value="5">5+ resenas</option>
                      <option value="10">10+ resenas</option>
                      <option value="25">25+ resenas</option>
                      <option value="50">50+ resenas</option>
                      <option value="100">100+ resenas</option>
                    </select>
                  </div>
                  <div class="checkbox-row">
                    <input type="checkbox" id="requirePhone" name="requirePhone">
                    <label for="requirePhone">Solo con telefono</label>
                  </div>
                  <div class="checkbox-row">
                    <input type="checkbox" id="requireWebsite" name="requireWebsite">
                    <label for="requireWebsite">Solo con sitio web</label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Google Sheets option -->
          <div class="form-group checkbox-group" id="sheetsOptionGroup" style="display: none; margin-top: 16px;">
            <label class="checkbox-label">
              <input type="checkbox" id="exportToSheets" name="exportToSheets" checked>
              <span class="checkmark"></span>
              Guardar automaticamente en Google Sheets
            </label>
          </div>

          <div class="button-group" style="display: flex; gap: 12px;">
            <button type="button" id="previewBtn" class="btn btn-secondary">
              <span class="btn-text">Vista Previa</span>
              <span class="btn-loading" style="display: none;">
                <span class="spinner"></span>
                Contando...
              </span>
            </button>
            <button type="submit" id="searchBtn" class="btn btn-primary">
              <span class="btn-text">Buscar Negocios</span>
              <span class="btn-loading" style="display: none;">
                <span class="spinner"></span>
                Buscando...
              </span>
            </button>
          </div>
        </form>
      </section>

      <!-- Preview Results -->
      <section id="previewSection" class="preview-section" style="display: none;">
        <div class="preview-card">
          <div class="preview-icon">&#128269;</div>
          <h3 id="previewTitle">Vista Previa</h3>
          <div class="preview-count">
            <span id="previewCount">0</span>
            <span class="preview-label">negocios encontrados</span>
          </div>
          <div id="previewSamples" class="preview-samples"></div>
          <div class="preview-actions">
            <button id="previewCancel" class="btn btn-secondary">Cancelar</button>
            <button id="previewConfirm" class="btn btn-primary">Iniciar Scraping</button>
          </div>
        </div>
      </section>
      </section>

      <!-- Progress -->
      <section id="progressSection" class="progress-section" style="display: none;">
        <div class="progress-info">
          <span id="progressText">Iniciando scraping...</span>
          <span id="progressPercent">0%</span>
        </div>
        <div class="progress-bar">
          <div id="progressFill" class="progress-fill"></div>
        </div>
      </section>

      <!-- Messages -->
      <section id="messageSection" class="message-section" style="display: none;">
        <div id="messageBox" class="message-box"></div>
      </section>

      <!-- Stats -->
      <section id="statsSection" style="display: none;">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-label">Total</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statPhone">0</div>
            <div class="stat-label">Con Telefono</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statEmail">0</div>
            <div class="stat-label">Con Email</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statWebsite">0</div>
            <div class="stat-label">Con Web</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statInstagram">0</div>
            <div class="stat-label">Instagram</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statWhatsapp">0</div>
            <div class="stat-label">WhatsApp</div>
          </div>
        </div>
      </section>

      <!-- Results -->
      <section id="resultsSection" class="results-section" style="display: none;">
        <div class="results-header">
          <div class="results-info">
            <h2>Resultados</h2>
            <span id="resultsCount" class="results-count"></span>
          </div>
          <div class="export-buttons">
            <button id="exportSheets" class="btn btn-google">Ver Google Sheets</button>
            <button id="exportCsv" class="btn btn-secondary">CSV</button>
            <button id="exportJson" class="btn btn-secondary">JSON</button>
          </div>
        </div>

        <div class="table-container">
          <table id="resultsTable" class="results-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Nombre</th>
                <th>Rating</th>
                <th>Categoria</th>
                <th>Telefono</th>
                <th>Email</th>
                <th>Redes</th>
                <th>Web</th>
                <th>Perfil</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>
      </section>

      <!-- Database Section -->
      <section id="databaseSection" class="database-section">
        <div class="db-header" id="dbToggle">
          <h3>Base de Datos Local</h3>
          <span class="db-toggle-icon">+</span>
        </div>
        <div id="dbContent" class="db-content" style="display: none;">
          <div class="db-stats-grid">
            <div class="db-stat-card">
              <span class="db-stat-number" id="dbTotalNegocios">0</span>
              <span class="db-stat-label">Total Negocios</span>
            </div>
            <div class="db-stat-card">
              <span class="db-stat-number" id="dbTotalCiudades">0</span>
              <span class="db-stat-label">Ciudades</span>
            </div>
            <div class="db-stat-card">
              <span class="db-stat-number" id="dbTotalCategorias">0</span>
              <span class="db-stat-label">Categorias</span>
            </div>
            <div class="db-stat-card">
              <span class="db-stat-number" id="dbTotalBusquedas">0</span>
              <span class="db-stat-label">Busquedas</span>
            </div>
          </div>
          
          <div class="db-details">
            <div class="db-detail-row">
              <span>Con telefono:</span>
              <strong id="dbConTelefono">0</strong>
            </div>
            <div class="db-detail-row">
              <span>Con email:</span>
              <strong id="dbConEmail">0</strong>
            </div>
            <div class="db-detail-row">
              <span>Con website:</span>
              <strong id="dbConWebsite">0</strong>
            </div>
            <div class="db-detail-row">
              <span>Rating promedio:</span>
              <strong id="dbRatingPromedio">0</strong>
            </div>
          </div>

          <div class="db-actions">
            <button id="dbRefresh" class="btn btn-secondary btn-sm">Actualizar</button>
            <button id="dbExport" class="btn btn-secondary btn-sm">Exportar Todo</button>
            <button id="dbLimpiar" class="btn btn-danger btn-sm">Limpiar Duplicados</button>
          </div>

          <div class="db-search">
            <input type="text" id="dbSearchInput" placeholder="Buscar en mis datos..." class="input-field">
            <button id="dbSearchBtn" class="btn btn-primary btn-sm">Buscar</button>
          </div>

          <div id="dbSearchResults" class="db-search-results" style="display: none;">
            <h4>Resultados de busqueda: <span id="dbSearchCount">0</span></h4>
            <div id="dbSearchList" class="db-search-list"></div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <p>GMB Scraper Pro v2.0 - 40+ campos por negocio</p>
    </footer>
  </div>

  <script>
    // Datos de estados y ciudades
    const statesData = {
      'Aguascalientes': { abbr: 'AGS', cities: ['Aguascalientes', 'Calvillo', 'Jesus Maria', 'Rincon de Romos', 'Pabellon de Arteaga'] },
      'Baja California': { abbr: 'BC', cities: ['Tijuana', 'Mexicali', 'Ensenada', 'Rosarito', 'Tecate', 'San Quintin'] },
      'Baja California Sur': { abbr: 'BCS', cities: ['La Paz', 'Cabo San Lucas', 'San Jose del Cabo', 'Loreto', 'Ciudad Constitucion'] },
      'Campeche': { abbr: 'CAM', cities: ['Campeche', 'Ciudad del Carmen', 'Champoton', 'Escarcega', 'Calkini'] },
      'Chiapas': { abbr: 'CHIS', cities: ['Tuxtla Gutierrez', 'San Cristobal de las Casas', 'Tapachula', 'Comitan', 'Palenque', 'Chiapa de Corzo'] },
      'Chihuahua': { abbr: 'CHIH', cities: ['Chihuahua', 'Juarez', 'Delicias', 'Cuauhtemoc', 'Parral', 'Nuevo Casas Grandes'] },
      'Ciudad de Mexico': { abbr: 'CDMX', cities: ['Ciudad de Mexico', 'Coyoacan', 'Xochimilco', 'Tlalpan', 'Iztapalapa', 'Gustavo A. Madero'] },
      'Coahuila': { abbr: 'COAH', cities: ['Saltillo', 'Torreon', 'Monclova', 'Piedras Negras', 'Acuna', 'Sabinas'] },
      'Colima': { abbr: 'COL', cities: ['Colima', 'Manzanillo', 'Tecoman', 'Villa de Alvarez', 'Armeria'] },
      'Durango': { abbr: 'DGO', cities: ['Durango', 'Gomez Palacio', 'Lerdo', 'Santiago Papasquiaro', 'Canatlan'] },
      'Estado de Mexico': { abbr: 'MEX', cities: ['Toluca', 'Ecatepec', 'Nezahualcoyotl', 'Naucalpan', 'Tlalnepantla', 'Cuautitlan Izcalli', 'Atizapan', 'Texcoco', 'Chalco'] },
      'Guanajuato': { abbr: 'GTO', cities: ['Leon', 'Irapuato', 'Celaya', 'Salamanca', 'Silao', 'Guanajuato', 'San Miguel de Allende', 'Dolores Hidalgo'] },
      'Guerrero': { abbr: 'GRO', cities: ['Acapulco', 'Chilpancingo', 'Iguala', 'Taxco', 'Zihuatanejo', 'Ixtapa'] },
      'Hidalgo': { abbr: 'HGO', cities: ['Pachuca', 'Tulancingo', 'Tula', 'Huejutla', 'Tizayuca', 'Actopan'] },
      'Jalisco': { abbr: 'JAL', cities: ['Guadalajara', 'Zapopan', 'Tlaquepaque', 'Tonala', 'Tlajomulco', 'Puerto Vallarta', 'Lagos de Moreno', 'Tepatitlan', 'Chapala', 'Tequila'] },
      'Michoacan': { abbr: 'MICH', cities: ['Morelia', 'Uruapan', 'Zamora', 'Lazaro Cardenas', 'Apatzingan', 'Patzcuaro', 'Zitacuaro'] },
      'Morelos': { abbr: 'MOR', cities: ['Cuernavaca', 'Jiutepec', 'Cuautla', 'Temixco', 'Yautepec', 'Tepoztlan'] },
      'Nayarit': { abbr: 'NAY', cities: ['Tepic', 'Bahia de Banderas', 'Compostela', 'Santiago Ixcuintla', 'San Blas', 'Sayulita'] },
      'Nuevo Leon': { abbr: 'NL', cities: ['Monterrey', 'San Pedro Garza Garcia', 'San Nicolas de los Garza', 'Guadalupe', 'Apodaca', 'Santa Catarina', 'Escobedo'] },
      'Oaxaca': { abbr: 'OAX', cities: ['Oaxaca', 'Salina Cruz', 'Juchitan', 'Tuxtepec', 'Huatulco', 'Puerto Escondido'] },
      'Puebla': { abbr: 'PUE', cities: ['Puebla', 'Tehuacan', 'San Martin Texmelucan', 'Atlixco', 'Cholula', 'Izucar de Matamoros'] },
      'Queretaro': { abbr: 'QRO', cities: ['Queretaro', 'San Juan del Rio', 'Corregidora', 'El Marques', 'Tequisquiapan'] },
      'Quintana Roo': { abbr: 'QROO', cities: ['Cancun', 'Playa del Carmen', 'Chetumal', 'Cozumel', 'Tulum', 'Isla Mujeres', 'Puerto Morelos'] },
      'San Luis Potosi': { abbr: 'SLP', cities: ['San Luis Potosi', 'Soledad de Graciano Sanchez', 'Ciudad Valles', 'Matehuala', 'Rioverde'] },
      'Sinaloa': { abbr: 'SIN', cities: ['Culiacan', 'Mazatlan', 'Los Mochis', 'Guasave', 'Navolato', 'El Rosario'] },
      'Sonora': { abbr: 'SON', cities: ['Hermosillo', 'Ciudad Obregon', 'Nogales', 'Guaymas', 'San Luis Rio Colorado', 'Navojoa', 'Puerto Penasco'] },
      'Tabasco': { abbr: 'TAB', cities: ['Villahermosa', 'Cardenas', 'Comalcalco', 'Paraiso', 'Macuspana'] },
      'Tamaulipas': { abbr: 'TAMPS', cities: ['Reynosa', 'Matamoros', 'Nuevo Laredo', 'Tampico', 'Ciudad Victoria', 'Ciudad Madero', 'Altamira'] },
      'Tlaxcala': { abbr: 'TLAX', cities: ['Tlaxcala', 'Apizaco', 'Huamantla', 'Chiautempan', 'Calpulalpan'] },
      'Veracruz': { abbr: 'VER', cities: ['Veracruz', 'Xalapa', 'Coatzacoalcos', 'Poza Rica', 'Cordoba', 'Orizaba', 'Minatitlan', 'Boca del Rio'] },
      'Yucatan': { abbr: 'YUC', cities: ['Merida', 'Valladolid', 'Progreso', 'Tizimin', 'Izamal', 'Uman'] },
      'Zacatecas': { abbr: 'ZAC', cities: ['Zacatecas', 'Fresnillo', 'Guadalupe', 'Jerez', 'Rio Grande', 'Sombrerete'] }
    };

    
    // C칍DIGOS POSTALES DE CULIAC츼N
    const codigosPostalesCuliacan = {
      "80000": ["Centro", "Centro Sinaloa"],
      "80010": ["Arboledas", "Ignacio Allende", "6 de Enero", "Villa Universidad"],
      "80013": ["Ciudad Universitaria", "Obrero Campesino", "Universitaria"],
      "80014": ["Zona Dorada", "Portabelo", "Las Glorias", "Maralago", "Buena Vista"],
      "80016": ["La Lima", "Los Mezcales", "El Ranchito"],
      "80017": ["El Barrio", "Palmares", "츼lamos"],
      "80019": ["Las Quintas", "La Campi침a", "Las Palmas"],
      "80020": ["Guadalupe Victoria", "Miguel Alem치n", "Independencia"],
      "80024": ["Las Vegas", "Terranova", "La Primavera"],
      "80028": ["Lomas de Guadalupe", "Chapultepec", "Los Pinos"],
      "80030": ["Recursos Hidr치ulicos", "Industrial"],
      "80040": ["Miguel Hidalgo", "Los Laureles"],
      "80050": ["Desarrollo Urbano 3 R칤os", "Tres R칤os"],
      "80058": ["El Vallado", "La Conquista"],
      "80060": ["Las Flores", "Juntas de Humaya"],
      "80063": ["Ca침adas", "Montecarlo", "La Cima"],
      "80064": ["La Rioja", "Los Sauces", "Fontanares"],
      "80065": ["Villas del R칤o", "Rinc칩n del Humaya"],
      "80080": ["Colinas de San Miguel", "Colinas del Real"],
      "80090": ["Valle Alto", "Hacienda San Rafael"],
      "80100": ["Humaya", "Villa del Rey"],
      "80104": ["Stanza", "Prados del Sur"],
      "80105": ["Antonio Rosales", "5 de Febrero"],
      "80110": ["Emiliano Zapata", "Tierra Blanca"],
      "80120": ["Gabriel Leyva", "Fovissste"],
      "80128": ["Infonavit Humaya", "Infonavit Barrancos"],
      "80130": ["Bachigualato", "Campo El Diez"],
      "80150": ["Juan de Dios B치tiz", "Adolfo L칩pez Mateos"],
      "80155": ["L치zaro C치rdenas", "Solidaridad"],
      "80158": ["Villa Bonita", "Villa del Cedro"],
      "80170": ["Los 츼ngeles", "Santa Fe"],
      "80180": ["Isla Musala", "21 de Marzo"],
      "80190": ["Nuevo Culiac치n", "Estero", "Loma Linda"],
      "80194": ["CTM", "Sinaloa"],
      "80196": ["Progreso", "Pradera Dorada"],
      "80200": ["El Diez", "La Costera"],
      "80210": ["El Mirador", "Centro Norte"],
      "80220": ["Los 츼ngeles Norte", "Los Naranjos"],
      "80230": ["G칠nova", "Mediterr치neo"],
      "80260": ["El Port칩n", "El Canad치"],
      "80280": ["Aguaruto Centro", "Aguaruto Norte"],
      "80300": ["Navolato Centro"],
      "80430": ["Eldorado"],
      "80450": ["Quil치"],
      "80470": ["Sanalona"]
    };
    
    let showingPostalCodes = false;
    let selectedPostalCode = null;

    const stateInput = document.getElementById('state');
    const cityInput = document.getElementById('city');
    const stateDropdown = document.getElementById('stateDropdown');
    const cityDropdown = document.getElementById('cityDropdown');
    const stateOptions = document.getElementById('stateOptions');
    const cityOptions = document.getElementById('cityOptions');
    const stateClear = document.getElementById('stateClear');
    const cityClear = document.getElementById('cityClear');
    const cityDropdownHeader = document.getElementById('cityDropdownHeader');

    let selectedState = null;

    function highlightMatch(text, filter) {
      if (!filter) return text;
      const escaped = filter.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const regex = new RegExp('(' + escaped + ')', 'gi');
      return text.replace(regex, '<mark style="background:#fef08a;padding:0 2px;border-radius:2px">$1</mark>');
    }

    function getAllCitiesWithState() {
      const result = [];
      for (const [state, data] of Object.entries(statesData)) {
        for (const city of data.cities) {
          result.push({ city, state, abbr: data.abbr });
        }
      }
      return result;
    }

    function renderStates(filter = '') {
      stateOptions.innerHTML = '';
      const states = Object.keys(statesData).filter(s => 
        s.toLowerCase().includes(filter.toLowerCase()) ||
        statesData[s].abbr.toLowerCase().includes(filter.toLowerCase())
      );
      
      if (states.length === 0) {
        stateOptions.innerHTML = '<div class="dropdown-empty">No se encontraron estados</div>';
        return;
      }
      
      states.forEach(state => {
        const data = statesData[state];
        const item = document.createElement('div');
        item.className = 'dropdown-item' + (selectedState === state ? ' selected' : '');
        item.innerHTML = 
          '<div class="item-icon">' + data.abbr.substring(0,2) + '</div>' +
          '<div class="item-text">' +
            '<div class="main">' + highlightMatch(state, filter) + '</div>' +
            '<div class="sub">' + highlightMatch(data.abbr, filter) + '</div>' +
          '</div>' +
          '<span class="item-count">' + data.cities.length + ' ciudades</span>';
        item.addEventListener('click', () => selectState(state));
        stateOptions.appendChild(item);
      });
    }

    function renderCities(filter = '') {
      cityOptions.innerHTML = '';
      let citiesToShow = [];
      
      if (selectedState) {
        citiesToShow = statesData[selectedState].cities.map(city => ({
          city, state: selectedState, abbr: statesData[selectedState].abbr
        }));
        cityDropdownHeader.textContent = 'Ciudades de ' + selectedState;
      } else if (filter && filter.length >= 1) {
        citiesToShow = getAllCitiesWithState();
        cityDropdownHeader.textContent = 'Resultados de busqueda';
      } else {
        const popularCities = ['Ciudad de Mexico', 'Guadalajara', 'Monterrey', 'Puebla', 'Tijuana', 'Leon', 'Cancun', 'Merida', 'Queretaro', 'San Luis Potosi', 'Aguascalientes', 'Morelia', 'Chihuahua', 'Culiacan', 'Hermosillo', 'Acapulco', 'Veracruz', 'Oaxaca', 'Mazatlan', 'Toluca'];
        citiesToShow = getAllCitiesWithState().filter(c => popularCities.includes(c.city));
        cityDropdownHeader.textContent = 'Ciudades populares';
      }
      
      const filtered = filter 
        ? citiesToShow.filter(c => c.city.toLowerCase().includes(filter.toLowerCase()))
        : citiesToShow;
      
      const limited = filtered.slice(0, 30);
      
      if (limited.length === 0) {
        cityOptions.innerHTML = '<div class="dropdown-empty">No se encontraron ciudades</div>';
        return;
      }
      
      limited.forEach(({ city, state, abbr }) => {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        const showState = !selectedState;
        item.innerHTML = 
          '<div class="item-icon">游늸</div>' +
          '<div class="item-text">' +
            '<div class="main">' + highlightMatch(city, filter) + '</div>' +
            (showState ? '<div class="sub">' + state + ' (' + abbr + ')</div>' : '') +
          '</div>';
        item.addEventListener('click', () => selectCity(city));
        cityOptions.appendChild(item);
      });
      
      if (filter && filtered.length > 30) {
        const moreDiv = document.createElement('div');
        moreDiv.className = 'dropdown-empty';
        moreDiv.textContent = '...y ' + (filtered.length - 30) + ' mas. Escribe para filtrar.';
        cityOptions.appendChild(moreDiv);
      }
    }

    function selectState(state) {
      selectedState = state;
      stateInput.value = state;
      stateInput.parentElement.parentElement.classList.add('has-value');
      stateDropdown.classList.remove('show');
      renderCities();
      cityInput.value = '';
      cityInput.focus();
    }

    function selectCity(city) {
      cityInput.value = city;
      cityInput.parentElement.parentElement.classList.add('has-value');
      cityDropdown.classList.remove('show');
    }

    stateInput.addEventListener('focus', () => {
      renderStates(stateInput.value);
      stateDropdown.classList.add('show');
      cityDropdown.classList.remove('show');
    });

    stateInput.addEventListener('input', () => {
      renderStates(stateInput.value);
      stateDropdown.classList.add('show');
    });

    stateClear.addEventListener('click', (e) => {
      e.stopPropagation();
      selectedState = null;
      stateInput.value = '';
      stateInput.parentElement.parentElement.classList.remove('has-value');
      renderCities();
    });

    cityInput.addEventListener('focus', () => {
      renderCities(cityInput.value);
      cityDropdown.classList.add('show');
      stateDropdown.classList.remove('show');
    });

    cityInput.addEventListener('input', () => {
      renderCities(cityInput.value);
      cityDropdown.classList.add('show');
    });

    cityClear.addEventListener('click', (e) => {
      e.stopPropagation();
      cityInput.value = '';
      cityInput.parentElement.parentElement.classList.remove('has-value');
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('#stateSelect')) {
        stateDropdown.classList.remove('show');
      }
      if (!e.target.closest('#citySelect')) {
        cityDropdown.classList.remove('show');
      }
    });

    renderStates();
    renderCities();


    // ========== DROPDOWN DE PROFESIONES ==========
    
    const categoriesData = {
      'Servicios del Hogar': {
        icon: '游',
        items: ['Plomeros', 'Electricistas', 'Cerrajeros', 'Pintores', 'Carpinteros', 'Albaniles', 'Jardineros', 'Fumigadores', 'Impermeabilizadores', 'Aires acondicionados', 'Instaladores de gas', 'Herreros', 'Vidrieros', 'Tapiceros', 'Mudanzas', 'Limpieza de casas', 'Control de plagas', 'Plomeria', 'Instalaciones electricas', 'Remodelaciones', 'Pisos y azulejos', 'Canceleria de aluminio', 'Puertas y ventanas', 'Techos y laminas', 'Tinacos y cisternas']
      },
      'Salud y Medicina': {
        icon: '游낀',
        items: ['Medicos generales', 'Dentistas', 'Pediatras', 'Ginecologos', 'Cardiologos', 'Dermatologos', 'Oftalmologos', 'Traumatologos', 'Psicologos', 'Psiquiatras', 'Nutriologos', 'Quiropracticos', 'Fisioterapeutas', 'Veterinarios', 'Farmacias', 'Laboratorios clinicos', 'Clinicas', 'Hospitales', 'Opticas', 'Ortopedias', 'Consultorios medicos', 'Dentistas pediatricos', 'Ortodoncistas', 'Urologos', 'Neurologos', 'Geriatras', 'Medicina alternativa', 'Acupuntura', 'Homeopatia']
      },
      'Comida y Restaurantes': {
        icon: '游꽇勇',
        items: ['Restaurantes', 'Tacos', 'Taquerias', 'Mariscos', 'Pizzerias', 'Cafeterias', 'Pastelerias', 'Panaderias', 'Carnicerias', 'Tortillerias', 'Comida china', 'Comida japonesa', 'Sushi', 'Comida italiana', 'Birria', 'Pozole', 'Cocinas economicas', 'Food trucks', 'Bares', 'Antros', 'Discotecas', 'Hamburguesas', 'Hot dogs', 'Pollos asados', 'Buffet', 'Comida vegana', 'Comida vegetariana', 'Heladerias', 'Jugos y licuados', 'Cerveza artesanal']
      },
      'Belleza y Estetica': {
        icon: '游눊',
        items: ['Salones de belleza', 'Barberias', 'Spas', 'Manicure', 'Pedicure', 'Unas acrilicas', 'Esteticas', 'Maquillistas', 'Depilacion', 'Tatuajes', 'Peluquerias caninas', 'Tratamientos faciales', 'Masajes', 'Extensiones de pestanas', 'Microblading', 'Botox', 'Tratamientos capilares', 'Cortes de cabello', 'Tintes y mechas']
      },
      'Automotriz': {
        icon: '游뚱',
        items: ['Mecanicos', 'Talleres mecanicos', 'Refaccionarias', 'Llantas', 'Llanteras', 'Hojalateria y pintura', 'Autolavados', 'Agencias de autos', 'Autos usados', 'Gruas', 'Verificentros', 'Electromecanicos', 'Alineacion y balanceo', 'Frenos', 'Suspensiones', 'Clutch', 'Transmisiones', 'Aire acondicionado automotriz', 'Polarizado', 'Rines y llantas', 'Baterias', 'Mofles', 'Radiadores']
      },
      'Educacion': {
        icon: '游닄',
        items: ['Escuelas primarias', 'Escuelas secundarias', 'Preparatorias', 'Universidades', 'Guarderias', 'Kinders', 'Clases de ingles', 'Escuelas de idiomas', 'Clases de musica', 'Academias de baile', 'Escuelas de manejo', 'Tutores', 'Clases particulares', 'Cursos de computacion', 'Escuelas de natacion', 'Clases de karate', 'Escuelas de cocina', 'Capacitacion empresarial']
      },
      'Servicios Profesionales': {
        icon: '游눺',
        items: ['Abogados', 'Contadores', 'Notarios', 'Arquitectos', 'Ingenieros civiles', 'Disenadores graficos', 'Fotografos', 'Agentes de seguros', 'Agentes inmobiliarios', 'Consultores', 'Traductores', 'Detectives privados', 'Gestores', 'Asesores fiscales', 'Abogados de divorcios', 'Abogados penalistas', 'Abogados laborales', 'Valuadores', 'Peritos']
      },
      'Deportes y Fitness': {
        icon: '游끪勇',
        items: ['Gimnasios', 'Yoga', 'Pilates', 'CrossFit', 'Albercas', 'Natacion', 'Canchas de futbol', 'Artes marciales', 'Box', 'Boxeo', 'Entrenadores personales', 'Zumba', 'Spinning', 'Tenis', 'Padel', 'Escalada', 'Ciclismo', 'Running clubs']
      },
      'Comercio y Tiendas': {
        icon: '游',
        items: ['Ferreterias', 'Papelerias', 'Tiendas de ropa', 'Zapaterias', 'Joyerias', 'Mueblerias', 'Tiendas de electronica', 'Celulares', 'Tiendas de mascotas', 'Florerias', 'Licorerias', 'Abarrotes', 'Supermercados', 'Tiendas de materiales', 'Telas y merceria', 'Jugueterias', 'Librerias', 'Tiendas de regalos', 'Boutiques', 'Tiendas deportivas']
      },
      'Eventos y Entretenimiento': {
        icon: '游꿀',
        items: ['Salones de fiestas', 'DJ', 'Sonido', 'Organizadores de eventos', 'Payasos', 'Mariachis', 'Grupos musicales', 'Banquetes', 'Renta de mobiliario', 'Decoracion de eventos', 'Pinatas', 'Inflables', 'Quinceanerias', 'Bodas', 'Fotografos de eventos', 'Videografos', 'Catering', 'Iluminacion', 'Carpas y toldos']
      },
      'Tecnologia': {
        icon: '游눹',
        items: ['Reparacion de computadoras', 'Reparacion de celulares', 'Desarrollo web', 'Soporte tecnico', 'Camaras de seguridad', 'Internet', 'Imprentas', 'Diseno web', 'Redes y cableado', 'Sistemas de alarmas', 'Domotica', 'Servidores', 'Software', 'Apps moviles', 'Marketing digital', 'Community manager', 'SEO']
      },
      'Construccion e Industria': {
        icon: '游댢',
        items: ['Constructoras', 'Soldadores', 'Torneros', 'Maquinaria pesada', 'Renta de andamios', 'Block y tabique', 'Concreto premezclado', 'Gruas industriales', 'Topografia', 'Demoliciones', 'Excavaciones', 'Estructuras metalicas', 'Prefabricados', 'Acabados', 'Impermeabilizantes']
      }
    };
    
    const businessInput = document.getElementById('businessType');
    const businessDropdown = document.getElementById('businessDropdown');
    const businessOptions = document.getElementById('businessOptions');
    const businessClear = document.getElementById('businessClear');
    const businessDropdownHeader = document.getElementById('businessDropdownHeader');
    const businessSelect = document.getElementById('businessSelect');
    
    let selectedCategory = null;
    
    function getAllBusinessesWithCategory() {
      const result = [];
      for (const [category, data] of Object.entries(categoriesData)) {
        for (const item of data.items) {
          result.push({ name: item, category, icon: data.icon });
        }
      }
      return result;
    }
    
    function renderCategories(filter = '') {
      businessOptions.innerHTML = '';
      const categories = Object.keys(categoriesData).filter(c => 
        c.toLowerCase().includes(filter.toLowerCase())
      );
      
      if (categories.length === 0) {
        businessOptions.innerHTML = '<div class="dropdown-empty">No se encontraron categorias</div>';
        return;
      }
      
      categories.forEach(category => {
        const data = categoriesData[category];
        const item = document.createElement('div');
        item.className = 'dropdown-item' + (selectedCategory === category ? ' selected' : '');
        item.innerHTML = 
          '<div class="item-icon">' + data.icon + '</div>' +
          '<div class="item-text">' +
            '<div class="main">' + highlightMatch(category, filter) + '</div>' +
            '<div class="sub">' + data.items.length + ' profesiones</div>' +
          '</div>' +
          '<span class="item-count">' + data.items.length + '</span>';
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          selectCategory(category);
        });
        businessOptions.appendChild(item);
      });
    }
    
    function renderBusinesses(filter = '') {
      businessOptions.innerHTML = '';
      let itemsToShow = [];
      
      if (selectedCategory) {
        const data = categoriesData[selectedCategory];
        itemsToShow = data.items.map(name => ({
          name, category: selectedCategory, icon: data.icon
        }));
        businessDropdownHeader.textContent = selectedCategory;
      } else if (filter && filter.length >= 1) {
        itemsToShow = getAllBusinessesWithCategory();
        businessDropdownHeader.textContent = 'Resultados de busqueda';
      } else {
        // Profesiones populares
        const popular = ['Plomeros', 'Electricistas', 'Dentistas', 'Restaurantes', 'Tacos', 'Mecanicos', 'Abogados', 'Doctores', 'Gimnasios', 'Salones de belleza', 'Barberias', 'Farmacias', 'Veterinarios', 'Cerrajeros', 'Pintores', 'Contadores', 'Fotografos', 'Constructoras', 'Carpinteros', 'Jardineros'];
        itemsToShow = getAllBusinessesWithCategory().filter(b => popular.includes(b.name));
        businessDropdownHeader.textContent = 'Profesiones populares';
      }
      
      const filtered = filter 
        ? itemsToShow.filter(b => b.name.toLowerCase().includes(filter.toLowerCase()))
        : itemsToShow;
      
      const limited = filtered.slice(0, 30);
      
      if (limited.length === 0) {
        businessOptions.innerHTML = '<div class="dropdown-empty">No se encontraron resultados</div>';
        
        // Mostrar boton para ver categorias
        if (!selectedCategory) {
          const catBtn = document.createElement('div');
          catBtn.className = 'dropdown-item';
          catBtn.innerHTML = '<div class="item-icon">游늭</div><div class="item-text"><div class="main">Ver todas las categorias</div></div>';
          catBtn.addEventListener('click', () => {
            businessInput.value = '';
            renderCategories();
          });
          businessOptions.appendChild(catBtn);
        }
        return;
      }
      
      limited.forEach(({ name, category, icon }) => {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        const showCategory = !selectedCategory;
        item.innerHTML = 
          '<div class="item-icon">' + icon + '</div>' +
          '<div class="item-text">' +
            '<div class="main">' + highlightMatch(name, filter) + '</div>' +
            (showCategory ? '<div class="sub">' + category + '</div>' : '') +
          '</div>';
        item.addEventListener('click', () => selectBusiness(name));
        businessOptions.appendChild(item);
      });
      
      if (filter && filtered.length > 30) {
        const moreDiv = document.createElement('div');
        moreDiv.className = 'dropdown-empty';
        moreDiv.textContent = '...y ' + (filtered.length - 30) + ' mas. Escribe para filtrar.';
        businessOptions.appendChild(moreDiv);
      }
      
      // Boton para ver categorias si no hay filtro
      if (!filter && !selectedCategory) {
        const catBtn = document.createElement('div');
        catBtn.className = 'dropdown-item';
        catBtn.style.borderTop = '1px solid #e2e8f0';
        catBtn.style.marginTop = '8px';
        catBtn.style.paddingTop = '12px';
        catBtn.innerHTML = '<div class="item-icon">游늭</div><div class="item-text"><div class="main">Ver todas las categorias</div><div class="sub">12 categorias disponibles</div></div>';
        catBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          renderCategories();
          businessDropdownHeader.textContent = 'Categorias';
        });
        businessOptions.appendChild(catBtn);
      }
      
      // Boton para volver si hay categoria seleccionada
      if (selectedCategory) {
        const backBtn = document.createElement('div');
        backBtn.className = 'dropdown-item';
        backBtn.style.borderTop = '1px solid #e2e8f0';
        backBtn.style.marginTop = '8px';
        backBtn.style.paddingTop = '12px';
        backBtn.innerHTML = '<div class="item-icon"></div><div class="item-text"><div class="main">Volver a categorias</div></div>';
        backBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          selectedCategory = null;
          renderCategories();
          businessDropdownHeader.textContent = 'Categorias';
        });
        businessOptions.appendChild(backBtn);
      }
    }
    
    function selectCategory(category) {
      selectedCategory = category;
      renderBusinesses();
    }
    
    function selectBusiness(name) {
      businessInput.value = name;
      businessSelect.classList.add('has-value');
      businessDropdown.classList.remove('show');
      selectedCategory = null;
    }
    
    businessInput.addEventListener('focus', () => {
      if (businessInput.value.length >= 1) {
        renderBusinesses(businessInput.value);
      } else {
        renderBusinesses();
      }
      businessDropdown.classList.add('show');
      stateDropdown.classList.remove('show');
      cityDropdown.classList.remove('show');
    });
    
    businessInput.addEventListener('input', () => {
      selectedCategory = null;
      renderBusinesses(businessInput.value);
      businessDropdown.classList.add('show');
    });
    
    businessClear.addEventListener('click', (e) => {
      e.stopPropagation();
      businessInput.value = '';
      businessSelect.classList.remove('has-value');
      selectedCategory = null;
      renderBusinesses();
    });
    
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#businessSelect')) {
        businessDropdown.classList.remove('show');
      }
    });
    
    renderBusinesses();


    // ========== MEJORAS NIVEL 1 ==========
    
    // 1. NAVEGACI칍N CON TECLADO
    let activeDropdown = null;
    let activeIndex = -1;
    
    function getVisibleItems(dropdown) {
      return dropdown.querySelectorAll('.dropdown-item:not([style*="display: none"])');
    }
    
    function highlightItem(items, index) {
      items.forEach((item, i) => {
        item.classList.toggle('keyboard-active', i === index);
        if (i === index) {
          item.scrollIntoView({ block: 'nearest' });
        }
      });
    }
    
    function handleKeyboardNav(e, input, dropdown, optionsContainer) {
      const items = getVisibleItems(optionsContainer);
      if (items.length === 0) return;
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        activeIndex = Math.min(activeIndex + 1, items.length - 1);
        highlightItem(items, activeIndex);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        activeIndex = Math.max(activeIndex - 1, 0);
        highlightItem(items, activeIndex);
      } else if (e.key === 'Enter' && activeIndex >= 0) {
        e.preventDefault();
        items[activeIndex].click();
        activeIndex = -1;
      } else if (e.key === 'Escape') {
        dropdown.classList.remove('show');
        input.blur();
        activeIndex = -1;
      }
    }
    
    stateInput.addEventListener('keydown', (e) => {
      if (stateDropdown.classList.contains('show')) {
        handleKeyboardNav(e, stateInput, stateDropdown, stateOptions);
      }
    });
    
    cityInput.addEventListener('keydown', (e) => {
      if (cityDropdown.classList.contains('show')) {
        handleKeyboardNav(e, cityInput, cityDropdown, cityOptions);
      }
    });
    
    businessInput.addEventListener('keydown', (e) => {
      if (businessDropdown.classList.contains('show')) {
        handleKeyboardNav(e, businessInput, businessDropdown, businessOptions);
      }
    });
    


    // 2. HISTORIAL DE CIUDADES RECIENTES
    const HISTORY_KEY = 'gmb_recent_cities';
    const MAX_HISTORY = 5;
    
    function getRecentCities() {
      try {
        return JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
      } catch {
        return [];
      }
    }
    
    function saveRecentCity(city, state) {
      const recent = getRecentCities();
      const entry = { city, state, timestamp: Date.now() };
      
      // Remover si ya existe
      const filtered = recent.filter(r => r.city !== city);
      
      // Agregar al inicio
      filtered.unshift(entry);
      
      // Mantener solo los 칰ltimos MAX_HISTORY
      const trimmed = filtered.slice(0, MAX_HISTORY);
      
      localStorage.setItem(HISTORY_KEY, JSON.stringify(trimmed));
    }
    
    // Modificar selectCity para guardar en historial
    const originalSelectCity = selectCity;
    selectCity = function(city) {
      // Encontrar el estado de esta ciudad
      let foundState = selectedState;
      if (!foundState) {
        for (const [state, data] of Object.entries(statesData)) {
          if (data.cities.includes(city)) {
            foundState = state;
            break;
          }
        }
      }
      if (foundState) {
        saveRecentCity(city, foundState);
      }
      originalSelectCity(city);
    };
    
    // Modificar renderCities para mostrar recientes
    const originalRenderCities = renderCities;
    renderCities = function(filter = '') {
      // Si no hay filtro y no hay estado seleccionado, mostrar recientes primero
      if (!filter && !selectedState) {
        const recent = getRecentCities();
        if (recent.length > 0) {
          cityOptions.innerHTML = '';
          cityDropdownHeader.textContent = 'Ciudades recientes';
          
          recent.forEach(({ city, state }) => {
            const stateData = statesData[state];
            if (!stateData) return;
            
            const item = document.createElement('div');
            item.className = 'dropdown-item recent-item';
            item.innerHTML = 
              '<div class="item-icon">游뎷</div>' +
              '<div class="item-text">' +
                '<div class="main">' + city + '</div>' +
                '<div class="sub">' + state + '</div>' +
              '</div>';
            item.addEventListener('click', () => selectCity(city));
            cityOptions.appendChild(item);
          });
          
          // Separador
          const sep = document.createElement('div');
          sep.className = 'dropdown-separator';
          sep.innerHTML = '<span>Ciudades populares</span>';
          cityOptions.appendChild(sep);
          
          // Agregar populares despu칠s
          const popular = ['Ciudad de Mexico', 'Guadalajara', 'Monterrey', 'Puebla', 'Tijuana', 'Leon', 'Cancun', 'Merida', 'Queretaro', 'San Luis Potosi'];
          const allCities = getAllCitiesWithState();
          const popularCities = allCities.filter(c => popular.includes(c.city) && !recent.some(r => r.city === c.city));
          
          popularCities.slice(0, 10).forEach(({ city, state, abbr }) => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.innerHTML = 
              '<div class="item-icon">游늸</div>' +
              '<div class="item-text">' +
                '<div class="main">' + city + '</div>' +
                '<div class="sub">' + state + '</div>' +
              '</div>';
            item.addEventListener('click', () => selectCity(city));
            cityOptions.appendChild(item);
          });
          
          return;
        }
      }
      
      // Llamar a la funci칩n original si hay filtro o estado
      originalRenderCities(filter);
    };



    // 3. GEOLOCALIZACI칍N AUTOM츼TICA
    const geolocateBtn = document.getElementById('geolocateBtn');
    
    // Mapeo de coordenadas a ciudades (aproximado)
    const cityCoords = {
      'Ciudad de Mexico': { lat: 19.4326, lng: -99.1332, state: 'Ciudad de Mexico' },
      'Guadalajara': { lat: 20.6597, lng: -103.3496, state: 'Jalisco' },
      'Monterrey': { lat: 25.6866, lng: -100.3161, state: 'Nuevo Leon' },
      'Puebla': { lat: 19.0414, lng: -98.2063, state: 'Puebla' },
      'Tijuana': { lat: 32.5149, lng: -117.0382, state: 'Baja California' },
      'Leon': { lat: 21.1250, lng: -101.6860, state: 'Guanajuato' },
      'Cancun': { lat: 21.1619, lng: -86.8515, state: 'Quintana Roo' },
      'Merida': { lat: 20.9674, lng: -89.5926, state: 'Yucatan' },
      'Queretaro': { lat: 20.5888, lng: -100.3899, state: 'Queretaro' },
      'Culiacan': { lat: 24.8091, lng: -107.3940, state: 'Sinaloa' },
      'Mazatlan': { lat: 23.2494, lng: -106.4111, state: 'Sinaloa' },
      'Hermosillo': { lat: 29.0729, lng: -110.9559, state: 'Sonora' },
      'Aguascalientes': { lat: 21.8853, lng: -102.2916, state: 'Aguascalientes' },
      'Morelia': { lat: 19.7060, lng: -101.1950, state: 'Michoacan' },
      'Chihuahua': { lat: 28.6353, lng: -106.0889, state: 'Chihuahua' },
      'Saltillo': { lat: 25.4260, lng: -101.0053, state: 'Coahuila' },
      'Tampico': { lat: 22.2475, lng: -97.8572, state: 'Tamaulipas' },
      'Acapulco': { lat: 16.8531, lng: -99.8237, state: 'Guerrero' },
      'Veracruz': { lat: 19.1738, lng: -96.1342, state: 'Veracruz' },
      'Toluca': { lat: 19.2826, lng: -99.6557, state: 'Estado de Mexico' },
      'San Luis Potosi': { lat: 22.1565, lng: -100.9855, state: 'San Luis Potosi' },
      'Cuernavaca': { lat: 18.9242, lng: -99.2216, state: 'Morelos' },
      'Villahermosa': { lat: 17.9892, lng: -92.9475, state: 'Tabasco' },
      'Tuxtla Gutierrez': { lat: 16.7516, lng: -93.1028, state: 'Chiapas' },
      'Oaxaca': { lat: 17.0732, lng: -96.7266, state: 'Oaxaca' },
      'La Paz': { lat: 24.1426, lng: -110.3128, state: 'Baja California Sur' },
      'Tepic': { lat: 21.5085, lng: -104.8946, state: 'Nayarit' },
      'Durango': { lat: 24.0277, lng: -104.6532, state: 'Durango' },
      'Zacatecas': { lat: 22.7709, lng: -102.5832, state: 'Zacatecas' },
      'Campeche': { lat: 19.8301, lng: -90.5349, state: 'Campeche' },
      'Colima': { lat: 19.2433, lng: -103.7250, state: 'Colima' },
      'Pachuca': { lat: 20.1011, lng: -98.7591, state: 'Hidalgo' },
      'Tlaxcala': { lat: 19.3181, lng: -98.2375, state: 'Tlaxcala' },
      'Chetumal': { lat: 18.5001, lng: -88.2961, state: 'Quintana Roo' },
      'Chilpancingo': { lat: 17.5513, lng: -99.5007, state: 'Guerrero' }
    };
    
    function findNearestCity(lat, lng) {
      let nearest = null;
      let minDist = Infinity;
      
      for (const [city, coords] of Object.entries(cityCoords)) {
        const dist = Math.sqrt(Math.pow(lat - coords.lat, 2) + Math.pow(lng - coords.lng, 2));
        if (dist < minDist) {
          minDist = dist;
          nearest = { city, state: coords.state, distance: dist };
        }
      }
      
      return nearest;
    }
    
    geolocateBtn.addEventListener('click', async () => {
      if (!navigator.geolocation) {
        alert('Tu navegador no soporta geolocalizacion');
        return;
      }
      
      geolocateBtn.disabled = true;
      geolocateBtn.classList.add('loading');
      geolocateBtn.innerHTML = '<span class="spinner" style="width:14px;height:14px;border-width:2px;"></span> Detectando...';
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const { latitude, longitude } = position.coords;
          const nearest = findNearestCity(latitude, longitude);
          
          if (nearest && nearest.distance < 2) { // ~200km
            // Seleccionar estado
            selectedState = nearest.state;
            stateInput.value = nearest.state;
            stateInput.parentElement.parentElement.classList.add('has-value');
            
            // Seleccionar ciudad
            cityInput.value = nearest.city;
            cityInput.parentElement.parentElement.classList.add('has-value');
            
            // Guardar en historial
            saveRecentCity(nearest.city, nearest.state);
            
            geolocateBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> ' + nearest.city;
            
            setTimeout(() => {
              geolocateBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/></svg> Mi ubicacion';
            }, 2000);
          } else {
            alert('No pudimos encontrar una ciudad cercana. Por favor selecciona manualmente.');
          }
          
          geolocateBtn.disabled = false;
          geolocateBtn.classList.remove('loading');
        },
        (error) => {
          let msg = 'Error al obtener ubicacion';
          if (error.code === 1) msg = 'Permiso de ubicacion denegado';
          else if (error.code === 2) msg = 'Ubicacion no disponible';
          else if (error.code === 3) msg = 'Tiempo de espera agotado';
          
          alert(msg);
          geolocateBtn.disabled = false;
          geolocateBtn.classList.remove('loading');
          geolocateBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/></svg> Mi ubicacion';
        },
        { timeout: 10000, enableHighAccuracy: false }
      );
    });



    // 4. B칔SQUEDA TOLERANTE A ERRORES (Fuzzy Search)
    function normalizeText(text) {
      return text.toLowerCase()
        .normalize('NFD').replace(/[-폺]/g, '') // Quitar acentos
        .replace(/[^a-z0-9\s]/g, ''); // Solo letras y n칰meros
    }
    
    function fuzzyMatch(text, query) {
      const normalText = normalizeText(text);
      const normalQuery = normalizeText(query);
      
      // Coincidencia exacta normalizada
      if (normalText.includes(normalQuery)) return { match: true, score: 100 };
      
      // Coincidencia por palabras
      const queryWords = normalQuery.split(/\s+/);
      const textWords = normalText.split(/\s+/);
      let wordMatches = 0;
      for (const qw of queryWords) {
        if (textWords.some(tw => tw.includes(qw) || qw.includes(tw))) wordMatches++;
      }
      if (wordMatches > 0) return { match: true, score: 50 + (wordMatches / queryWords.length) * 30 };
      
      // Coincidencia aproximada (errores de tipeo)
      // Simplificado: verificar si al menos 70% de las letras coinciden en orden
      let matchCount = 0;
      let lastIndex = -1;
      for (const char of normalQuery) {
        const idx = normalText.indexOf(char, lastIndex + 1);
        if (idx > lastIndex) {
          matchCount++;
          lastIndex = idx;
        }
      }
      const ratio = matchCount / normalQuery.length;
      if (ratio >= 0.7) return { match: true, score: ratio * 50 };
      
      return { match: false, score: 0 };
    }
    
    // Sobrescribir las funciones de filtrado para usar fuzzy
    const originalRenderStates = renderStates;
    renderStates = function(filter = '') {
      if (!filter) {
        return originalRenderStates(filter);
      }
      
      stateOptions.innerHTML = '';
      const results = [];
      
      for (const state of Object.keys(statesData)) {
        const fuzzyState = fuzzyMatch(state, filter);
        const fuzzyAbbr = fuzzyMatch(statesData[state].abbr, filter);
        const bestScore = Math.max(fuzzyState.score, fuzzyAbbr.score);
        
        if (fuzzyState.match || fuzzyAbbr.match) {
          results.push({ state, score: bestScore });
        }
      }
      
      // Ordenar por score
      results.sort((a, b) => b.score - a.score);
      
      if (results.length === 0) {
        stateOptions.innerHTML = '<div class="dropdown-empty">No se encontraron estados</div>';
        return;
      }
      
      results.forEach(({ state }) => {
        const data = statesData[state];
        const item = document.createElement('div');
        item.className = 'dropdown-item' + (selectedState === state ? ' selected' : '');
        item.innerHTML = 
          '<div class="item-icon">' + data.abbr.substring(0,2) + '</div>' +
          '<div class="item-text">' +
            '<div class="main">' + highlightMatch(state, filter) + '</div>' +
            '<div class="sub">' + highlightMatch(data.abbr, filter) + '</div>' +
          '</div>' +
          '<span class="item-count">' + data.cities.length + ' ciudades</span>';
        item.addEventListener('click', () => selectState(state));
        stateOptions.appendChild(item);
      });
    };
    
    // Tambi칠n para ciudades en renderBusinesses y la b칰squeda de ciudades
    const savedOriginalRenderCities = renderCities;
    renderCities = function(filter = '') {
      if (!filter || filter.length < 2) {
        return savedOriginalRenderCities(filter);
      }
      
      cityOptions.innerHTML = '';
      let itemsToShow = [];
      
      if (selectedState) {
        itemsToShow = statesData[selectedState].cities.map(city => ({
          city, state: selectedState, abbr: statesData[selectedState].abbr
        }));
        cityDropdownHeader.textContent = 'Ciudades de ' + selectedState;
      } else {
        itemsToShow = getAllCitiesWithState();
        cityDropdownHeader.textContent = 'Resultados de busqueda';
      }
      
      // Aplicar fuzzy search
      const results = [];
      for (const item of itemsToShow) {
        const fuzzy = fuzzyMatch(item.city, filter);
        if (fuzzy.match) {
          results.push({ ...item, score: fuzzy.score });
        }
      }
      
      results.sort((a, b) => b.score - a.score);
      const limited = results.slice(0, 30);
      
      if (limited.length === 0) {
        cityOptions.innerHTML = '<div class="dropdown-empty">No se encontraron ciudades. Intenta con otra palabra.</div>';
        return;
      }
      
      limited.forEach(({ city, state, abbr }) => {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        const showState = !selectedState;
        item.innerHTML = 
          '<div class="item-icon">游늸</div>' +
          '<div class="item-text">' +
            '<div class="main">' + highlightMatch(city, filter) + '</div>' +
            (showState ? '<div class="sub">' + state + ' (' + abbr + ')</div>' : '') +
          '</div>';
        item.addEventListener('click', () => selectCity(city));
        cityOptions.appendChild(item);
      });
      
      if (results.length > 30) {
        const moreDiv = document.createElement('div');
        moreDiv.className = 'dropdown-empty';
        moreDiv.textContent = '...y ' + (results.length - 30) + ' mas';
        cityOptions.appendChild(moreDiv);
      }
    };


    
    // Mostrar c칩digos postales cuando se selecciona Culiac치n
    const originalSelectCityForCP = selectCity;
    selectCity = function(city) {
      originalSelectCityForCP(city);
      
      // Si es Culiac치n, mostrar opci칩n de c칩digo postal
      if (city.toLowerCase() === 'culiacan' || city.toLowerCase() === 'culiac치n') {
        setTimeout(() => {
          showPostalCodeOption();
        }, 300);
      }
    };
    
    function showPostalCodeOption() {
      // Crear bot칩n para mostrar CPs si no existe
      let cpBtn = document.getElementById('showCPBtn');
      if (!cpBtn) {
        const cityWrapper = cityInput.closest('.custom-select');
        cpBtn = document.createElement('button');
        cpBtn.type = 'button';
        cpBtn.id = 'showCPBtn';
        cpBtn.className = 'cp-toggle-btn';
        cpBtn.innerHTML = '游닕 Buscar por c칩digo postal (opcional)';
        cpBtn.addEventListener('click', togglePostalCodes);
        cityWrapper.appendChild(cpBtn);
      }
      cpBtn.style.display = 'block';
    }
    
    function togglePostalCodes() {
      showingPostalCodes = !showingPostalCodes;
      const cpBtn = document.getElementById('showCPBtn');
      
      if (showingPostalCodes) {
        cpBtn.innerHTML = '游닕 Ocultar c칩digos postales';
        renderPostalCodes();
        cityDropdown.classList.add('show');
      } else {
        cpBtn.innerHTML = '游닕 Buscar por c칩digo postal (opcional)';
        selectedPostalCode = null;
        // Restaurar valor original
        cityInput.value = 'Culiacan';
      }
    }
    
    function renderPostalCodes(filter = '') {
      cityOptions.innerHTML = '';
      cityDropdownHeader.textContent = 'C칩digos Postales de Culiac치n';
      
      const cps = Object.entries(codigosPostalesCuliacan);
      const filtered = filter 
        ? cps.filter(([cp, cols]) => 
            cp.includes(filter) || 
            cols.some(c => c.toLowerCase().includes(filter.toLowerCase()))
          )
        : cps;
      
      if (filtered.length === 0) {
        cityOptions.innerHTML = '<div class="dropdown-empty">No se encontr칩 ese c칩digo postal</div>';
        return;
      }
      
      filtered.forEach(([cp, colonias]) => {
        const item = document.createElement('div');
        item.className = 'dropdown-item cp-item';
        item.innerHTML = 
          '<div class="item-icon">游닕</div>' +
          '<div class="item-text">' +
            '<div class="main">' + cp + '</div>' +
            '<div class="sub">' + colonias.slice(0, 3).join(', ') + (colonias.length > 3 ? '...' : '') + '</div>' +
          '</div>';
        item.addEventListener('click', () => selectPostalCode(cp, colonias));
        cityOptions.appendChild(item);
      });
      
      // Bot칩n para volver a ciudad completa
      const backBtn = document.createElement('div');
      backBtn.className = 'dropdown-item';
      backBtn.style.borderTop = '1px solid #e2e8f0';
      backBtn.style.marginTop = '8px';
      backBtn.innerHTML = '<div class="item-icon">游끷勇</div><div class="item-text"><div class="main">Usar toda la ciudad</div><div class="sub">Buscar en todo Culiac치n</div></div>';
      backBtn.addEventListener('click', () => {
        selectedPostalCode = null;
        cityInput.value = 'Culiacan';
        cityDropdown.classList.remove('show');
        showingPostalCodes = false;
        document.getElementById('showCPBtn').innerHTML = '游닕 Buscar por c칩digo postal (opcional)';
      });
      cityOptions.appendChild(backBtn);
    }
    
    function selectPostalCode(cp, colonias) {
      selectedPostalCode = cp;
      cityInput.value = cp + ' (Culiac치n - ' + colonias[0] + ')';
      cityDropdown.classList.remove('show');
    }
    
    // Modificar b칰squeda de ciudades para incluir CPs cuando est치 en modo CP
    cityInput.addEventListener('input', () => {
      if (showingPostalCodes) {
        renderPostalCodes(cityInput.value);
        cityDropdown.classList.add('show');
      }
    });

    // Reset index cuando se abre dropdown
    stateInput.addEventListener('focus', () => { activeIndex = -1; });
    cityInput.addEventListener('focus', () => { activeIndex = -1; });
    businessInput.addEventListener('focus', () => { activeIndex = -1; });

  </script>
  <script src="app-advanced.js"></script>
</body>
</html>
